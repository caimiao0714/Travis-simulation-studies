{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Correlated Counfounder and Propensity Score Matching\"\nauthor: \"Miao Cai\"\ndate: '`r Sys.Date()`'\noutput:\n  tufte::tufte_html: default\n  tufte::tufte_handout:\n    citation_package: natbib\n    latex_engine: xelatex\n  tufte::tufte_book:\n    citation_package: natbib\n    latex_engine: xelatex\nlink-citations: yes\n---\n\n```{r setup, include=FALSE}\nlibrary(tufte)\n# invalidate cache when the tufte version changes\nknitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tufte'))\noptions(htmltools.dir.version = FALSE)\n```\n\n# Corrections in this 20171202 version\n## 1 Keep the directions of Cohen's d consistent across all comparisons\nThis is correctified by explicitly assigning the levels of the factors `levels = c(0, 1)` in `cohen.d(dat$y,factor(dat$tr, levels = c(0, 1)))$estimate`.\n\n## 2 Cohen's d for all 9 covariates, for 3 covariates and 3 PCs\n\n## 3 Adding the 7 covariates and 5 covariates part\n\n## 3 Display the loading factors\n\n## 4 Adding the Sufficient Reduction Method\n\n\n# Creating simulation data\nRandom variables $X_1$ - $X_3$ have the correlation coefficient of 0.3; random variables $X_4$ - $X_6$ have the correlation coefficient of 0.5; random variables $X_7$ - $X_9$ have the correlation coefficient of 0.8. The true population parameters for $X_1, X_4, X_7$ is 2, parameters for $X_2, X_5, X_8$ is 3, parameters for $X_3, X_6, X_9$ is 1.\n```{r ,cache=FALSE}\nlibrary(MASS)\nlibrary(Matrix)\nlibrary(GMCM)\nlibrary(MatchIt)\nset.seed(666)\n\n# correlations\nr1 = 0.3\nr2 = 0.5\nr3 = 0.8\n\n# block diagnoal correlation matrix\nm1 = matrix(r1, nrow=3, ncol=3)\ndiag(m1) = 1\nm2 = matrix(r2, nrow=3, ncol=3)\ndiag(m2) = 1\nm3 = matrix(r3, nrow=3, ncol=3)\ndiag(m3) = 1\n\ncmat = bdiag(m1, m2, m3)\n\n# covariates\nx = data.frame(mvrnorm(n=1000, mu=rep(0,9), Sigma=cmat))\n\n# pt: the probability to draw the binary treatment\n##REVISED: rowSums(x)-3.8 to reduce proportion treated\npt = GMCM:::inv.logit(rowSums(x)-3.8)\n## REVISED: to confirm that mean(pt) is near 0.2\nmean(pt) \n# mean(pt) is around 0.2 to make sure there are sufficient \n# number of comparison groups to choose from.\n\n# tr: treatment\ntr = rbinom(n = 1000, size = 1, prob = pt)\n\n# y: outcome - POPULATION PARAMETER for treatment is 3\ny = rnorm(n = 1000, \n          mean = tr * 3 + 3*x$X1 + 2*x$X2 + x$X3 + 3*x$X4 + 2*x$X5 + x$X6 + 3*x$X7 + 2*x$X8 + x$X9, \n          sd = 1)\n\n# constructing the data.frame\ndat <- data.frame(x, tr, y)\n```\n\\newpage\n\n# Part 1 Nine Covariates\nThis part firstly uses all 9 correlated covariates to match the treatment and comparison group^[Propensity score method is used to match the treatment group and the comparison group. I use the [**MatchIt** package](https://github.com/cran/MatchIt) to do propensity score matching]. Then I use linear regression to estimate the coefficients of $X_1 \\sim X_9$, and Cohen's d is used to test the effect size.^[Cohen's d is calculated using the following formula:$$Cohen's \\ d = \\frac{\\bar{X_1} - \\bar{X_2}}{\\sqrt{\\frac{(n_1-1)s_1^2 + (n_2 - 1)s_2^2}{n_1 + n_2 - 2}}}$$ ,with the _cohen.d()_ function in the [**effsize** package](https://github.com/cran/effsize). When paired is set, the effect size is computed using the approach suggested in (Gibbons et al. 1993) _Gibbons, R. D., Hedeker, D. R., & Davis, J. M. (1993). Estimation of effect size from a series of experiments involving paired comparisons. Journal of Educational Statistics, 18, 271-279._]\n\n## Section 1.1 Nine covariates without matching\n## 1.1.1 `y ~ tr` on unmatched data\n```{r}\nlibrary(effsize)\nlm1.1.1 <- lm(y ~ tr, data = dat)\n\n# summary the output\nknitr::kable(\n  summary(lm1.1.1)$coefficients, \n  caption = 'Linear regression between y and treatment on unmatched data', \n  digits = 3\n)\n\n# get the Cohen's d for this model\ncohen.d(dat$y,factor(dat$tr, levels = c(0, 1)))$estimate\n```\n\n## 1.1.2 `y ~ tr + 9` covariates on unmatched data\n```{r}\nlm1.1.2 <- lm(y ~ tr + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9,\n              data = dat)\n\n# summary the output\nknitr::kable(\n  summary(lm1.1.2)$coefficients, \n  caption = 'Linear regression between y and treatment, 9 covariates on unmatched data', \n  digits = 3\n)\n```\n\n## 1.1.3 Cohen's d for each covariate by tr\n```{r}\ncohen.d(dat$X1,factor(dat$tr, levels = c(0, 1)))$estimate\ncohen.d(dat$X2,factor(dat$tr, levels = c(0, 1)))$estimate\ncohen.d(dat$X3,factor(dat$tr, levels = c(0, 1)))$estimate\ncohen.d(dat$X4,factor(dat$tr, levels = c(0, 1)))$estimate\ncohen.d(dat$X5,factor(dat$tr, levels = c(0, 1)))$estimate\ncohen.d(dat$X6,factor(dat$tr, levels = c(0, 1)))$estimate\ncohen.d(dat$X7,factor(dat$tr, levels = c(0, 1)))$estimate\ncohen.d(dat$X8,factor(dat$tr, levels = c(0, 1)))$estimate\ncohen.d(dat$X9,factor(dat$tr, levels = c(0, 1)))$estimate\n```\n\n\n##Section 1.2 Nine covariates with matching\n## 1.2.1 `y ~ tr` on matched data\n```{r}\n#1 match the treatment and comparison groups - 1 to 1 match\nmatcheddata1 <- match.data(\n  matchit(tr ~ X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9, \n          data = dat, \n          method = \"nearest\", \n          ratio = 1))\n\n#2 linear regression - y and treatment on matched data\nlm1.2.1 <- lm(y ~ tr, data = matcheddata1)\nknitr::kable(\n  summary(lm1.2.1)$coefficients, \n  caption = 'Linear regression between y and treatment on matched data', \n  digits = 3\n)\n\ncohen.d(matcheddata1$y, factor(matcheddata1$tr, levels = c(0, 1)))$estimate\n```\n\n## 1.2.2 `y ~ tr + 9` covariates on matched data\n```{r}\n#3.2 linear regression - y, treatment and covariates\nlm1.2.2 <- lm(y ~ tr + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9, \n            data = matcheddata1)\nknitr::kable(\n  summary(lm1.2.2)$coefficients, \n  caption = 'Linear regression between y ,treatment and 9 covariates', \n  digits = 3\n)\n\n#4 effect size - Cohen's d\ncohen.d(matcheddata1$y, factor(matcheddata1$tr, levels = c(0, 1)))$estimate\n```\n\n## 1.2.3 Cohen's d for each covariate by tr\n```{r}\ncohen.d(matcheddata1$X1,factor(matcheddata1$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata1$X2,factor(matcheddata1$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata1$X3,factor(matcheddata1$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata1$X4,factor(matcheddata1$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata1$X5,factor(matcheddata1$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata1$X6,factor(matcheddata1$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata1$X7,factor(matcheddata1$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata1$X8,factor(matcheddata1$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata1$X9,factor(matcheddata1$tr, levels = c(0, 1)))$estimate\n```\n\n\\newpage\n\n# Part 2 Seven Covariates (X1 ~ X7)\nThis part compares the results regressing $X_1$ - $X_7$ on y and the regression after propensity score matching.\n\n## Section 2.1 Seven covariates without matching\n## 2.1.1 `y ~ tr + X1~X7` on unmatched data\n```{r}\nlibrary(effsize)\nlm2.1.1 <- lm(y ~ tr + X1 + X2 + X3 + X4 + X5 + X6 + X7,\n              data = dat)\n\n# summary the output\nknitr::kable(\n  summary(lm2.1.1)$coefficients, \n  caption = 'Linear regression between y and treatment, 7 covariates on unmatched data', \n  digits = 3\n)\n\n# get the Cohen's d for this model\ncohen.d(dat$y,factor(dat$tr, levels = c(0, 1)))$estimate\n```\n\n## Section 2.2 Seven covariates with matching\n## 2.2.1 `y ~ tr` on matched data\n```{r}\n#1 match the treatment and comparison groups - 1 to 1 match\nmatcheddata2 <- match.data(\n  matchit(tr ~ X1 + X2 + X3 + X4 + X5 + X6 + X7, \n          data = dat, \n          method = \"nearest\", \n          ratio = 1))\n\n#2 linear regression - y and treatment on matched data\nlm2.2.1 <- lm(y ~ tr, data = matcheddata2)\nknitr::kable(\n  summary(lm2.2.1)$coefficients, \n  caption = 'Linear regression between y and treatment on matched data',   digits = 3\n)\n\ncohen.d(matcheddata2$y, factor(matcheddata2$tr, levels = c(0, 1)))$estimate\n```\n\n## 2.2.2 `y ~ tr + X1~X7` on matched data\n```{r}\n#2.2 linear regression - y, treatment and 7 covariates\nlm2.2.2 <- lm(y ~ tr + X1 + X2 + X3 + X4 + X5 + X6 + X7, \n            data = matcheddata2)\nknitr::kable(\n  summary(lm2.2.2)$coefficients, \n  caption = 'Linear regression between y ,treatment and 7 covariates', \n  digits = 3\n)\n\n#4 effect size - Cohen's d\ncohen.d(matcheddata2$y, factor(matcheddata2$tr, levels = c(0, 1)))$estimate\n```\n\n## 2.2.3 Cohen's d for each covariate by tr\n```{r}\ncohen.d(matcheddata2$X1,factor(matcheddata2$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata2$X2,factor(matcheddata2$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata2$X3,factor(matcheddata2$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata2$X4,factor(matcheddata2$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata2$X5,factor(matcheddata2$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata2$X6,factor(matcheddata2$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata2$X7,factor(matcheddata2$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata2$X8,factor(matcheddata2$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata2$X9,factor(matcheddata2$tr, levels = c(0, 1)))$estimate\n```\n\\newpage\n\n# Part 3 Five Covariates (X1 ~ X5)\nThis part compares the results regressing $X_1$ - $X_5$ on y and the regression after propensity score matching.\n\n## Section 3.1 Five covariates without matching\n## 3.1.1 `y ~ tr + X1~X5` on unmatched data\n```{r}\nlibrary(effsize)\nlm3.1.1 <- lm(y ~ tr + X1 + X2 + X3 + X4 + X5,\n              data = dat)\n\n# summary the output\nknitr::kable(\n  summary(lm3.1.1)$coefficients, \n  caption = 'Linear regression between y and treatment, 5 covariates on unmatched data', \n  digits = 3\n)\n\n# get the Cohen's d for this model\ncohen.d(dat$y,factor(dat$tr, levels = c(0, 1)))$estimate\n```\n\n## Section 3.2 Five covariates with matching\n## 3.2.1 `y ~ tr` on matched data\n```{r}\n#1 match the treatment and comparison groups - 1 to 1 match\nmatcheddata3 <- match.data(\n  matchit(tr ~ X1 + X2 + X3 + X4 + X5, \n          data = dat, \n          method = \"nearest\", \n          ratio = 1))\n\n#2 linear regression - y and treatment on matched data\nlm3.2.1 <- lm(y ~ tr, data = matcheddata3)\nknitr::kable(\n  summary(lm3.2.1)$coefficients, \n  caption = 'Linear regression between y and treatment on matched data',   digits = 3\n)\n\ncohen.d(matcheddata3$y, factor(matcheddata3$tr, levels = c(0, 1)))$estimate\n```\n\n## 3.2.2 `y ~ tr + X1~X7` on matched data\n```{r}\n# linear regression - y, treatment and 5 covariates\nlm3.2.2 <- lm(y ~ tr + X1 + X2 + X3 + X4 + X5, \n            data = matcheddata3)\nknitr::kable(\n  summary(lm3.2.2)$coefficients, \n  caption = 'Linear regression between y ,treatment and 9 covariates', \n  digits = 3\n)\n\n# effect size - Cohen's d\ncohen.d(matcheddata3$y, factor(matcheddata3$tr, levels = c(0, 1)))$estimate\n```\n\n## 3.2.3 Cohen's d for each covariate by tr\n```{r}\ncohen.d(matcheddata3$X1,factor(matcheddata3$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata3$X2,factor(matcheddata3$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata3$X3,factor(matcheddata3$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata3$X4,factor(matcheddata3$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata3$X5,factor(matcheddata3$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata3$X6,factor(matcheddata3$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata3$X7,factor(matcheddata3$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata3$X8,factor(matcheddata3$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata3$X9,factor(matcheddata3$tr, levels = c(0, 1)))$estimate\n```\n\\newpage\n\n# Part 4 Three Covariates\nThis part firstly uses 3 correlated covariates to match the treatment and comparison group. Then propensity scores are used to match the treatment groups and comparison groups. Linear regression and Cohen's d are conducted after propensity score matching.\n\n## Section 4.1 Three uncorrelated covariates on unmatched data\n## 4.1.1 `y ~ tr + 3` uncorrelated covariates on unmatched data\n```{r}\nlm4.1.1 <- lm(y ~ tr + X1 + X4 + X7, data = dat)\n\n# summary the output\nknitr::kable(\n  summary(lm4.1.1)$coefficients, \n  caption = 'Linear regression between y and treatment, 3 uncorrelated covariates on unmatched data', \n  digits = 3\n)\n```\n\n## Section 4.2 Three uncorrelated covariates on matched data\n## 4.2.1 `y ~ tr` on matched data\n```{r}\n#1 match the treatment and comparison groups - 1 to 1 match\nmatcheddata4 <- match.data(\n  matchit(tr ~ X1 + X4 + X7, \n          data = dat, \n          method = \"nearest\", \n          ratio = 1))\n\n#2 linear regression - y and treatment\nlm4.2.1 <- lm(y ~ tr, data = matcheddata4)\nknitr::kable(\n  summary(lm4.2.1)$coefficients, \n  caption = 'Linear regression between y and treatment on matched data', \n  digits = 3\n)\n\n#3 Cohen's d\ncohen.d(matcheddata4$y, factor(matcheddata4$tr, levels = c(0, 1)))$estimate\n```\n\n## 4.2.2 `y ~ tr + X1 + X4 + X7` on matched data\n```{r}\n#1 linear regression - y， treatment and covariates\nlm4.2.2 <- lm(y ~ tr + X1 + X4 + X7, \n            data = matcheddata4)\nknitr::kable(\n  summary(lm4.2.2)$coefficients, \n  caption = 'Linear regression between y ,treatment and 3 covariates on matched data', \n  digits = 3\n)\n\n#2 Cohen's d\ncohen.d(matcheddata4$y, factor(matcheddata4$tr, levels = c(0, 1)))$estimate\n```\n\n## 4.2.3 Cohen's d for each covariate by tr\n```{r}\ncohen.d(matcheddata4$X1,factor(matcheddata4$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata4$X2,factor(matcheddata4$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata4$X3,factor(matcheddata4$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata4$X4,factor(matcheddata4$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata4$X5,factor(matcheddata4$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata4$X6,factor(matcheddata4$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata4$X7,factor(matcheddata4$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata4$X8,factor(matcheddata4$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata4$X9,factor(matcheddata4$tr, levels = c(0, 1)))$estimate\n```\n\\newpage\n\n# Part 5 Integrating 9 Covariates into 3 Principal Components\nThis part integrates the 9 covariates into 3 principal components using one principal component analysis.^[Prinpal component analysis is conducted using the base R function _prcomp()_] Then propensity scores are used to match the treatment groups and comparison groups using the 3 principal components. Linear regression and Cohen's d are conducted after propensity score matching.\n\n## Section 5.1 Regression on unmatched data\n## 5.1.1 Principle component analysis\n```{r}\n#1 principal component analysis\npca3 <- prcomp(dat[,paste(\"X\", 1:9, sep = \"\")], scale = FALSE)\npca3data <- data.frame(\n  dat$y, \n  dat$tr, \n  pca3$x[,1:3]\n  )#extract the  three PCs, y and tr\nnames(pca3data) <- c(\"y\", \"tr\", \"PC1\", \"PC2\", \"PC3\")\n\n#2 The standard deviation of the principle components\nknitr::kable(\n  pca3$sdev, \n  caption = 'The standard deviation of the principle components', \n  digits = 3\n)\n\n#3 The matrix of variable loadings (columns are eigenvectors)\nknitr::kable(\n  pca3$rotation, \n  caption = 'The matrix of variable loadings (columns are eigenvectors)', \n  digits = 3\n)\n\n#4 The variable means\nknitr::kable(\n  pca3$center, \n  caption = 'The variable means', \n  digits = 3\n)\n```\n\n## 5.1.2 `y ~ tr + 3PCs` on unmatched data\n```{r}\n#2 Linear regression on unmatched data\nlm5.1.2 <- lm(y ~ tr + PC1 + PC2 + PC3, data = pca3data)\n\n# summary the output\nknitr::kable(\n  summary(lm5.1.2)$coefficients, \n  caption = 'Linear regression between y and treatment and 3 PCs on unmatched data', \n  digits = 3\n)\n\n# get the Cohen's d for this model\ncohen.d(pca3data$y, factor(pca3data$tr, levels = c(0, 1)))$estimate\n```\n\n## 5.1.3 Cohen's d for each covariate by tr\n```{r}\ncohen.d(pca3data$PC1,factor(pca3data$tr, levels = c(0, 1)))$estimate\ncohen.d(pca3data$PC2,factor(pca3data$tr, levels = c(0, 1)))$estimate\ncohen.d(pca3data$PC3,factor(pca3data$tr, levels = c(0, 1)))$estimate\n```\n\n## Section 5.2 Regression on matched data\n## 5.2.1 `y ~ tr` on matched data\n```{r}\n#1 propensity score matching - one to one match\nmatcheddata5 <- match.data(\n  matchit(tr ~ PC1 + PC2 + PC3, \n          data = pca3data, \n          method = \"nearest\", \n          ratio = 1))\n\n#2 combine the PCs data (including PC1 - PC3) and original data (including X1 - X9)\nmatcheddata5 <- cbind(matcheddata5, dat[rownames(matcheddata5),-c(which(colnames(dat) == \"y\"), which(colnames(dat) == \"tr\"))])\n\n#3 linear regression - y and treatment\nlm5.2.1 <- lm(y ~ tr, data = matcheddata5)\nknitr::kable(\n  summary(lm5.2.1)$coefficients, \n  caption = 'Linear regression between y and treatment on matched data', \n  digits = 3\n)\n\n#4 Cohen's d\ncohen.d(matcheddata5$y, factor(matcheddata5$tr, levels = c(0, 1)))$estimate\n```\n\n## 5.2.2 `y ~ tr + 3PC` on matched data\n```{r}\n#1 linear regression - y， treatment and covariates\nlm5.2.2 <- lm(y ~ tr + PC1 + PC2 + PC3, \n            data = matcheddata5)\nknitr::kable(\n  summary(lm5.2.2)$coefficients, \n  caption = 'Linear regression between y ,treatment and 3 PCs on matched data', \n  digits = 3\n)\n\n#2 Cohen's d\ncohen.d(matcheddata5$y, matcheddata5$tr)$estimate\n```\n\n## 5.2.3 Cohen's d for each covariate by tr\n```{r}\n#1 Cohen's d for each PCs by tr\ncohen.d(matcheddata5$PC1,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata5$PC2,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata5$PC3,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\n\n#2 Cohen's d for each covariate by tr\ncohen.d(matcheddata5$X1,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata5$X2,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata5$X3,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata5$X4,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata5$X5,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata5$X6,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata5$X7,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata5$X8,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata5$X9,factor(matcheddata5$tr, levels = c(0, 1)))$estimate\n```\n\\newpage\n\n# Part 6 Separately Integrating 9 Covariates into 3 sets of Principal Components\nThis part separately integrates the 9 covariates into 3 sets principal components.^[Different from part 3, this part uses 3 principal component analyses and integrates $X_1 - X_3$ into $PC_1$, integrates $X_4 - X_6$ into $PC_2$, and integrates $X_7 - X_9$ into $PC_3$.] Then propensity scores are used to match the treatment groups and comparison groups using the 3 sets of principal components. Linear regression and Cohen's d are conducted after propensity score matching.\n\n## Section 6.1 Regression on unmatched data\n## 6.1.1 principal component analysis - 3 sets\n```{r}\n# principal component analysis - 3 sets\npca6.1 <- prcomp(dat[,paste(\"X\", 1:3, sep = \"\")], scale = FALSE)\npca6.2 <- prcomp(dat[,paste(\"X\", 4:6, sep = \"\")], scale = FALSE)\npca6.3 <- prcomp(dat[,paste(\"X\", 7:9, sep = \"\")], scale = FALSE)\npca6data <- data.frame(\n  dat$y, \n  dat$tr, \n  pca6.1$x[,1],\n  pca6.2$x[,1],\n  pca6.3$x[,1]\n  )#extract the  three PCs, y and tr\nnames(pca6data) <- c(\"y\", \"tr\", \"PC1\", \"PC2\", \"PC3\")\n\n# Set 1: X1 ~ X3\n## 1.1 The standard deviation of the principle components\nknitr::kable(\n  pca6.1$sdev, \n  caption = 'The standard deviation of the principle components set 1',\n  digits = 3\n)\n\n## 1.2 The matrix of variable loadings (columns are eigenvectors)\nknitr::kable(\n  pca6.1$rotation, \n  caption = 'The matrix of variable loadings set1', \n  digits = 3\n)\n\n## 1.3 The variable means\nknitr::kable(\n  pca6.1$center, \n  caption = 'The variable means set 1', \n  digits = 3\n)\n\n# Set 2: X4 ~ X6\n## 2.1 The standard deviation of the principle components\nknitr::kable(\n  pca6.2$sdev, \n  caption = 'The standard deviation of the principle components set 2',\n  digits = 3\n)\n\n## 2.2 The matrix of variable loadings (columns are eigenvectors)\nknitr::kable(\n  pca6.2$rotation, \n  caption = 'The matrix of variable loadings set2', \n  digits = 3\n)\n\n## 2.3 The variable means\nknitr::kable(\n  pca6.2$center, \n  caption = 'The variable means set 2', \n  digits = 3\n)\n\n# Set 3: X7 ~ X9\n## 3.1 The standard deviation of the principle components\nknitr::kable(\n  pca6.3$sdev, \n  caption = 'The standard deviation of the principle components set 3',\n  digits = 3\n)\n\n## 3.2 The matrix of variable loadings (columns are eigenvectors)\nknitr::kable(\n  pca6.3$rotation, \n  caption = 'The matrix of variable loadings set 3', \n  digits = 3\n)\n\n## 3.3 The variable means\nknitr::kable(\n  pca6.3$center, \n  caption = 'The variable means set 3', \n  digits = 3\n)\n```\n\n## 6.1.2 `y ~ tr + 3PCs` on unmatched data\n```{r}\n#2 Linear regression on unmatched data\nlm6.1.2 <- lm(y ~ tr + PC1 + PC2 + PC3, data = pca6data)\n\n# summary the output\nknitr::kable(\n  summary(lm6.1.2)$coefficients, \n  caption = 'Linear regression between y and treatment and 3 PCs on unmatched data', \n  digits = 3\n)\n\n# get the Cohen's d for this model\ncohen.d(pca6data$y, factor(pca6data$tr, levels = c(0, 1)))$estimate\n```\n\n## 6.1.3 Cohen's d for each covariate by tr\n```{r}\ncohen.d(pca6data$PC1,factor(pca6data$tr, levels = c(0, 1)))$estimate\ncohen.d(pca6data$PC2,factor(pca6data$tr, levels = c(0, 1)))$estimate\ncohen.d(pca6data$PC3,factor(pca6data$tr, levels = c(0, 1)))$estimate\n```\n\n## Section 6.2 Regression on matched data\n## 6.2.1 `y ~ tr` on matched data\n```{r}\n#1 propensity score matching\nmatcheddata6 <- match.data(\n  matchit(tr ~ PC1 + PC2 + PC3, \n          data = pca6data, \n          method = \"nearest\", \n          ratio = 1))\n\n#2 combine the PCs data (including PC1 - PC3) and original data (including X1 - X9)\nmatcheddata6 <- cbind(matcheddata6, dat[rownames(matcheddata6),-c(which(colnames(dat) == \"y\"), which(colnames(dat) == \"tr\"))])\n\n#2 linear regression - y and treatment\nlm6.1 <- lm(y ~ tr, data = matcheddata6)\nknitr::kable(\n  summary(lm6.1)$coefficients, \n  caption = 'Linear regression between y and treatment on matched data', \n  digits = 3\n)\n\n#3 Cohen's d\ncohen.d(matcheddata6$y, factor(matcheddata6$tr, levels = c(0, 1)))$estimate\n```\n\n## 6.2.2 `y ~ tr + 3PC` on matched data\n```{r}\n#1 linear regression - y， treatment and covariates\nlm6.2 <- lm(y ~ tr + PC1 + PC2 + PC3, \n            data = matcheddata6)\nknitr::kable(\n  summary(lm6.2)$coefficients, \n  caption = 'Linear regression between y ,treatment and 3 PCs on matched data', \n  digits = 3\n)\n\n#2 Cohen's d\ncohen.d(matcheddata6$y, factor(matcheddata6$tr, levels = c(0, 1)))$estimate\n```\n\n## 6.2.3 Cohen's d for each covariate by tr\n```{r}\n#1 Cohen's d for each PCs by tr\ncohen.d(matcheddata6$PC1,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata6$PC2,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata6$PC3,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\n\n#2 Cohen's d for each covariate by tr\ncohen.d(matcheddata6$X1,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata6$X2,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata6$X3,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata6$X4,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata6$X5,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata6$X6,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata6$X7,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata6$X8,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\ncohen.d(matcheddata6$X9,factor(matcheddata6$tr, levels = c(0, 1)))$estimate\n```\n\n\n\n\n",
    "created" : 1512320306227.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2702442914",
    "id" : "271DA860",
    "lastKnownWriteTime" : 1512297354,
    "last_content_update" : 1512297354,
    "path" : "D:/Program Files (x86)/onedrive/OneDrive - Saint Louis University/Travis-simulation studies/Correlated confounders 20171202.Rmd",
    "project_path" : "Correlated confounders 20171202.Rmd",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}